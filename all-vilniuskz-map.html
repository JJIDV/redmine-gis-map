<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Vilniaus užduotys (poligonai)</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #app {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #map {
      flex: 1;
    }

    #sidebar {
      width: 220px;
      max-width: 220px;
      border-left: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      font-size: 12px;
    }

    #sidebar-header {
      padding: 6px 8px;
      border-bottom: 1px solid #ddd;
      background: #f7f7f7;
      font-weight: 600;
      font-size: 12px;
      text-align: center;
    }

    #filter {
      padding: 4px 6px;
      border: none;
      border-bottom: 1px solid #ddd;
      outline: none;
      font-size: 12px;
    }

    #list {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
    }

    .feature-row {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .feature-row:hover {
      background: #f0f8ff;
    }

    .feature-row.active {
      background: #e6f2ff;
    }

    .row-title {
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-sub {
      color: #555;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #status-bar {
      padding: 3px 6px;
      border-top: 1px solid #ddd;
      font-size: 10px;
      color: #555;
      background: #fafafa;
      text-align: center;
    }

    @media (max-width: 700px) {
      #sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <div id="sidebar">
      <div id="sidebar-header">Užduotys (st. 1, 6)</div>
      <input id="filter" type="text" placeholder="Filtruoti pagal įmonę / statusą..." />
      <div id="list"></div>
      <div id="status-bar">Kraunama...</div>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ArcGIS sluoksnis su poligonais
    const arcgisLayerUrl =
      "https://opencity.idvilnius.lt/atviras/rest/services/Eismo_valdymas/Uzduotys_PROJ_QL/MapServer/0";

    // Tik statusai 1 arba 6
    const whereClause = "Statusas IN (1, 6)";

    // Kodai -> tekstas
    const statusMap = {
      1: "Vykdoma",
      6: "Sukurta"
    };

    const companyMap = {
      0: "Nenurodyta",
      1: "VMSA",
      2: "SISP",
      3: "VVT",
      4: "Grinda",
      5: "Biseris",
      6: "Maniga",
      7: "Gatas"
    };

    // Leaflet žemėlapis
    const map = L.map("map").setView([54.6872, 25.2797], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap"
    }).addTo(map);

    const listEl = document.getElementById("list");
    const filterInput = document.getElementById("filter");
    const statusBar = document.getElementById("status-bar");

    let allItems = [];
    let polygonsLayer = L.geoJSON(null, {
      style: feature => styleByStatus(feature.properties.statusCode)
    }).addTo(map);

    // --- Stiliai pagal statusą ---
    function styleByStatus(statusCode) {
      if (statusCode === 1) {
        // Vykdoma – mėlyna
        return {
          color: "#0052cc",
          weight: 1,
          fillColor: "#4c9aff",
          fillOpacity: 0.4
        };
      } else if (statusCode === 6) {
        // Sukurta – geltona
        return {
          color: "#e3a900",
          weight: 1,
          fillColor: "#ffe58f",
          fillOpacity: 0.4
        };
      }
      // default
      return {
        color: "#666",
        weight: 1,
        fillColor: "#cccccc",
        fillOpacity: 0.3
      };
    }

    // ESRI Polygon -> GeoJSON Polygon
    function esriPolygonToGeoJSON(geom) {
      if (!geom || !geom.rings) return null;
      return {
        type: "Polygon",
        coordinates: geom.rings.map(ring =>
          ring.map(([x, y]) => [x, y]) // jau WGS84 iš outSR=4326
        )
      };
    }

    // Paprastas query be BBOX – pasiimam visus Statusas IN (1, 6)
    function createQueryUrl() {
      const params = new URLSearchParams({
        where: whereClause,
        outFields: "OBJECTID,Statusas,Imone",
        returnGeometry: "true",
        outSR: "4326",
        f: "pjson"
      });
      return arcgisLayerUrl + "/query?" + params.toString();
    }

    function renderList(items) {
      listEl.innerHTML = "";
      items.forEach(item => listEl.appendChild(item.rowEl));
      statusBar.textContent = "Rodomos " + items.length + " užduotys";
    }

    function applyFilter() {
      const q = (filterInput.value || "").trim().toLowerCase();
      if (!q) {
        renderList(allItems);
        return;
      }
      const filtered = allItems.filter(item =>
        (item.searchText || "").toLowerCase().includes(q)
      );
      renderList(filtered);
    }

    async function loadData() {
      statusBar.textContent = "Kraunama...";
      const url = createQueryUrl();

      try {
        const resp = await fetch(url);
        const data = await resp.json();

        if (data.error) {
          console.error("ArcGIS error:", data.error);
          statusBar.textContent = "Klaida iš serverio";
          return;
        }

        const features = data.features || [];
        polygonsLayer.clearLayers();
        allItems = [];

        if (!features.length) {
          statusBar.textContent = "Užduočių nėra";
          renderList(allItems);
          return;
        }

        const geojsonFeatures = [];

        features.forEach(f => {
          const a = f.attributes || {};
          const g = f.geometry;

          const statusCode = a.Statusas;
          if (statusCode !== 1 && statusCode !== 6) return;

          const statusText = statusMap[statusCode] || ("Statusas " + statusCode);
          const companyText = companyMap[a.Imone] || ("Įmonė " + a.Imone);
          const gjGeom = esriPolygonToGeoJSON(g);
          if (!gjGeom) return;

          const gjFeature = {
            type: "Feature",
            geometry: gjGeom,
            properties: {
              objectId: a.OBJECTID,
              statusCode,
              statusText,
              companyText
            }
          };
          geojsonFeatures.push(gjFeature);
        });

        // Pridėti į Leaflet
        polygonsLayer = L.geoJSON(geojsonFeatures, {
          style: feature => styleByStatus(feature.properties.statusCode),
          onEachFeature: (feature, layer) => {
            const p = feature.properties;
            const popupHtml =
              `<b>Užduotis #${p.objectId}</b><br>` +
              `Įmonė: ${p.companyText}<br>` +
              `Statusas: ${p.statusText}`;
            layer.bindPopup(popupHtml);

            layer.on("click", () => {
              if (p._rowEl) {
                document
                  .querySelectorAll(".feature-row.active")
                  .forEach(el => el.classList.remove("active"));
                p._rowEl.classList.add("active");
                p._rowEl.scrollIntoView({
                  behavior: "smooth",
                  block: "center"
                });
              }
            });
          }
        }).addTo(map);

        // Sąrašas dešinėje
        polygonsLayer.eachLayer(layer => {
          const p = layer.feature.properties;
          const row = document.createElement("div");
          row.className = "feature-row";
          row.innerHTML =
            `<div class="row-title">Užduotis #${p.objectId}</div>` +
            `<div class="row-sub">Įmonė: ${p.companyText}</div>` +
            `<div class="row-sub">Statusas: ${p.statusText}</div>`;

          row.onclick = () => {
            const bounds = layer.getBounds();
            map.fitBounds(bounds.pad(0.2));
            layer.openPopup();

            document
              .querySelectorAll(".feature-row.active")
              .forEach(el => el.classList.remove("active"));
            row.classList.add("active");
          };

          p._rowEl = row;

          allItems.push({
            rowEl: row,
            searchText:
              `#${p.objectId} ${p.companyText} ${p.statusText}`,
            layer
          });
        });

        // Zoominam į visų poligonų aprėptį
        const allBounds = polygonsLayer.getBounds();
        if (allBounds.isValid()) {
          map.fitBounds(allBounds.pad(0.1));
        }

        renderList(allItems);
      } catch (e) {
        console.error(e);
        statusBar.textContent = "Klaida įkeliant duomenis";
      }
    }

    map.whenReady(loadData);

    if (filterInput) {
      filterInput.addEventListener("input", applyFilter);
    }
  </script>
</body>
</html>
