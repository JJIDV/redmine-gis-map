<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Vilniaus užduočių žemėlapis (Statusas 1,4,6)</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ===== KONFIGŪRACIJA =====
    const arcgisLayerUrl =
      "https://opencity.idvilnius.lt/atviras/rest/services/Eismo_valdymas/Uzduotys_PROJ_QL/MapServer/0";

    // Filtruojame tik neuždarytas užduotis:
    // 1 – Vykdoma, 4 – Atlikta, 6 – Sukurta
    const whereClause = "Statusas IN (1, 4, 6)";

    // Imone kodo -> pavadinimo žodynas
    const companyNames = {
      0: "Nenurodyta",
      1: "VMSA",
      2: "SISP",
      3: "VVT",
      4: "Grinda",
      5: "Biseris",
      6: "Maniga",
      7: "Gatas"
    };

    // Statuso kodo -> teksto žodynas (jei reikės)
    const statusNames = {
      1: "Vykdoma",
      4: "Atlikta",
      6: "Sukurta"
    };

    // ===== ŽEMĖLAPIS =====
    const map = L.map("map").setView([54.6872, 25.2797], 11); // Vilnius

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap"
    }).addTo(map);

    // ===== PAGALBINĖS FUNKCIJOS =====

    // Centroidas paprastam poligonui (pirmam žiedui)
    function polygonCentroid(rings) {
      // tikimės: rings = [ [ [x1,y1], [x2,y2], ... ] , ... ]
      if (!rings || !rings.length || !rings[0].length) return null;
      const pts = rings[0];

      let twiceArea = 0;
      let x = 0;
      let y = 0;
      const n = pts.length;

      for (let i = 0; i < n - 1; i++) {
        const xi = pts[i][0];
        const yi = pts[i][1];
        const xj = pts[i + 1][0];
        const yj = pts[i + 1][1];
        const a = xi * yj - xj * yi;
        twiceArea += a;
        x += (xi + xj) * a;
        y += (yi + yj) * a;
      }

      if (twiceArea === 0) {
        return { x: pts[0][0], y: pts[0][1] };
      }

      const factor = 1 / (3 * twiceArea);
      return { x: x * factor, y: y * factor };
    }

    // LKS94 -> WGS84 (apytikslis, pakanka vizualizacijai)
    function lksToWgs(x, y) {
      const x0 = 500000;
      const y0 = 0;
      const lon = (x - x0) * 0.0000105 + 24.0;
      const lat = (y - y0) * 0.0000065 + 54.5;
      return { lat, lon };
    }

    function createQueryUrl() {
      const params = new URLSearchParams({
        where: whereClause,
        outFields: "*",
        returnGeometry: "true",
        f: "pjson"
        // Jei norėtum, kad serveris pats perprojektuotų:
        // outSR: "4326"
      });
      return arcgisLayerUrl + "/query?" + params.toString();
    }

    // ===== DUOMENŲ KROVIMAS =====
    async function loadData() {
      try {
        const url = createQueryUrl();
        console.log("Query URL:", url);

        const resp = await fetch(url);
        const data = await resp.json();
        console.log("Received data sample:", data);

        if (!data.features || !Array.isArray(data.features) || data.features.length === 0) {
          console.warn("Nerasta jokių objektų pagal sąlygą:", whereClause);
          return;
        }

        const markers = [];

        data.features.forEach((f) => {
          const attrs = f.attributes || {};
          const geom = f.geometry;

          if (!geom || !geom.rings) return;

          const c = polygonCentroid(geom.rings);
          if (!c) return;

          // Konvertuojame iš LKS į WGS
          const { lat, lon } = lksToWgs(c.x, c.y);

          const statusCode = attrs.Statusas;
          const companyCode = attrs.Imone;

          const statusText = statusNames[statusCode] || `Statusas ${statusCode}`;
          const companyText = companyNames[companyCode] || `Imonė kodas ${companyCode}`;

          const popupHtml = `
            <b>${companyText}</b><br/>
            Statusas: <b>${statusText}</b> (kodas: ${statusCode})<br/>
            Lat: ${lat.toFixed(5)} | Lon: ${lon.toFixed(5)}
          `;

          const marker = L.marker([lat, lon]).addTo(map);
          marker.bindPopup(popupHtml);

          markers.push(marker);
        });

        // priartiname vaizdą prie visų taškų
        if (markers.length) {
          const group = L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
        }
      } catch (e) {
        console.error("Klaida skaitant duomenis:", e);
      }
    }

    loadData();
  </script>
</body>
</html>
