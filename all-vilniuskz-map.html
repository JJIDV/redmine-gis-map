<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>PROJ užduotys (statusai 1, 6)</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Paprastas išdėstymas -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    #app {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #map {
      flex: 1;
    }

    #sidebar {
      width: 220px;
      max-width: 220px;
      border-left: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      font-size: 12px;
    }

    #sidebar-header {
      padding: 6px 8px;
      border-bottom: 1px solid #ddd;
      background: #f7f7f7;
      font-weight: 600;
      font-size: 12px;
      text-align: center;
    }

    #filter {
      padding: 4px 6px;
      border: none;
      border-bottom: 1px solid #ddd;
      outline: none;
      font-size: 12px;
    }

    #list {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
    }

    .feature-row {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .feature-row:hover {
      background: #f0f8ff;
    }

    .feature-row.active {
      background: #e6f2ff;
    }

    .row-title {
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-sub {
      color: #555;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-coords {
      color: #777;
      font-size: 10px;
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #status-bar {
      padding: 3px 6px;
      border-top: 1px solid #ddd;
      font-size: 10px;
      color: #555;
      background: #fafafa;
      text-align: center;
    }

    /* Mažuose ekranuose paslepiam šoninę juostą */
    @media (max-width: 600px) {
      #sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <div id="sidebar">
      <div id="sidebar-header">Užduotys (st. 1, 6)</div>
      <input id="filter" type="text" placeholder="Filtruoti pagal įmonę / statusą..." />
      <div id="list"></div>
      <div id="status-bar">Kraunama...</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- proj4 – koordinačių konvertavimui LKS94 -> WGS84 -->
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.2/dist/proj4.js"></script>

  <script>
    // --- ArcGIS sluoksnio adresas ---
    const arcgisLayerUrl =
      "https://opencity.idvilnius.lt/atviras/rest/services/Eismo_valdymas/Uzduotys_PROJ_QL/MapServer/0";

    // Rodome tik neuždarytas: 1 (Vykdoma), 6 (Sukurta)
    const whereClause = "Statusas IN (1, 6)";

    // LKS94 (EPSG:3346) -> WGS84 (EPSG:4326) definicija
    // Šita proj4 eilutė yra standartinis LKS94 / Lithuania TM proj4 aprašas
    proj4.defs(
      "EPSG:3346",
      "+proj=laea +lat_0=54 +lon_0=24 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs"
    );

    // Leaflet žemėlapis
    const map = L.map("map").setView([54.6872, 25.2797], 11); // Vilnius

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap"
    }).addTo(map);

    const listEl = document.getElementById("list");
    const filterInput = document.getElementById("filter");
    const statusBar = document.getElementById("status-bar");

    let allItems = []; // visų įrašų masyvas su markeriais + HTML eilutėmis

    // Kodo -> įmonės pavadinimo žodynas
    const companyMap = {
      0: "Nenurodyta",
      1: "VMSA",
      2: "SISP",
      3: "VVT",
      4: "Grinda",
      5: "Biseris",
      6: "Maniga",
      7: "Gatas"
    };

    // Statuso kodas -> tekstas
    const statusMap = {
      1: "Vykdoma",
      6: "Sukurta"
    };

    function createQueryUrl() {
      const params = new URLSearchParams({
        where: whereClause,
        outFields: "OBJECTID,Statusas,Imone,X_koord,Y_koord",
        returnGeometry: "false",       // geometrijos NEimam – naud. X/Y laukus
        f: "pjson"
      });
      return arcgisLayerUrl + "/query?" + params.toString();
    }

    function renderList(items) {
      if (!listEl) return;
      listEl.innerHTML = "";
      items.forEach((item) => listEl.appendChild(item.rowEl));
      statusBar.textContent = "Rodomos " + items.length + " užduotys";
    }

    function applyFilter() {
      const q = filterInput.value.trim().toLowerCase();
      if (!q) {
        renderList(allItems);
        return;
      }
      const filtered = allItems.filter((item) =>
        (item.searchText || "").toLowerCase().includes(q)
      );
      renderList(filtered);
    }

    async function loadData() {
      try {
        const url = createQueryUrl();
        console.log("Query URL:", url);

        const resp = await fetch(url);
        const data = await resp.json();
        console.log("Received data sample:", data);

        if (!data.features || !data.features.length) {
          statusBar.textContent = "Nerasta užduočių (statusai 1, 6)";
          return;
        }

        const markers = [];

        data.features.forEach((f) => {
          const a = f.attributes || {};

          const statusCode = a.Statusas;
          if (statusCode !== 1 && statusCode !== 6) return; // saugiklis

          const imoneCode = a.Imone;
          const imoneName = companyMap[imoneCode] || `Kod. ${imoneCode}`;
          const statusName = statusMap[statusCode] || `Kod. ${statusCode}`;

          const x = a.X_koord;
          const y = a.Y_koord;
          if (x == null || y == null) return;

          // LKS94 -> WGS84
          const [lon, lat] = proj4("EPSG:3346", "EPSG:4326", [x, y]);

          // Marker
          const marker = L.marker([lat, lon]).addTo(map);

          marker.bindPopup(
            `<b>Užduotis #${a.OBJECTID}</b><br>` +
            `Įmonė: ${imoneName}<br>` +
            `Statusas: ${statusName}<br>` +
            `Lat: ${lat.toFixed(5)} | Lon: ${lon.toFixed(5)}`
          );

          // Eilutė sąraše
          const row = document.createElement("div");
          row.className = "feature-row";
          row.innerHTML =
            `<div class="row-title">Užduotis #${a.OBJECTID}</div>` +
            `<div class="row-sub">Įmonė: ${imoneName}</div>` +
            `<div class="row-sub">Statusas: ${statusName}</div>` +
            `<div class="row-coords">${lat.toFixed(5)}, ${lon.toFixed(5)}</div>`;

          row.onclick = () => {
            map.setView([lat, lon], 17);
            marker.openPopup();
            document
              .querySelectorAll(".feature-row.active")
              .forEach((el) => el.classList.remove("active"));
            row.classList.add("active");
          };

          marker.on("click", () => {
            row.scrollIntoView({ behavior: "smooth", block: "center" });
            document
              .querySelectorAll(".feature-row.active")
              .forEach((el) => el.classList.remove("active"));
            row.classList.add("active");
          });

          allItems.push({
            marker,
            rowEl: row,
            searchText: `${a.OBJECTID} ${imoneName} ${statusName}`
          });

          markers.push(marker);
        });

        if (markers.length) {
          const group = L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
        }

        renderList(allItems);
      } catch (e) {
        console.error("Klaida įkeliant duomenis:", e);
        statusBar.textContent = "Klaida įkeliant duomenis";
      }
    }

    if (filterInput) filterInput.addEventListener("input", applyFilter);
    loadData();
  </script>
</body>
</html>
