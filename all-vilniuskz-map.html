<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Uzduotys PROJ – poligonai</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #app {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #map {
      flex: 1;
    }

    #sidebar {
      flex: 0 0 180px;
      max-width: 180px;
      border-left: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      font-size: 12px;
    }

    #sidebar-header {
      padding: 6px 8px;
      border-bottom: 1px solid #ddd;
      background: #f7f7f7;
      font-weight: 600;
      font-size: 12px;
      text-align: center;
    }

    #filter {
      padding: 4px 6px;
      border: none;
      border-bottom: 1px solid #ddd;
      outline: none;
      font-size: 12px;
    }

    #list {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
    }

    .feature-row {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .feature-row:hover {
      background: #f0f8ff;
    }

    .feature-row.active {
      background: #e6f2ff;
    }

    .row-title {
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-sub {
      color: #555;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #status-bar {
      padding: 3px 6px;
      border-top: 1px solid #ddd;
      font-size: 10px;
      color: #555;
      background: #fafafa;
      text-align: center;
    }

    /* mobile – paslepiam sąrašą */
    @media (max-width: 600px) {
      #sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <div id="sidebar">
      <div id="sidebar-header">Užduotys (st. 1, 6)</div>
      <input id="filter" type="text" placeholder="Filtruoti pagal įmonę / statusą..." />
      <div id="list"></div>
      <div id="status-bar">Kraunama...</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ArcGIS MapServer sluoksnis
    const arcgisLayerUrl =
      "https://opencity.idvilnius.lt/atviras/rest/services/Eismo_valdymas/Uzduotys_PROJ_QL/MapServer/0";

    // Imonės kodų -> pavadinimų žodynas
    const IMONE_MAP = {
      0: "Nenurodyta",
      1: "VMSA",
      2: "SISP",
      3: "VVT",
      4: "Grinda",
      5: "Biseris",
      6: "Maniga",
      7: "Gatas"
    };

    // Statuso kodų -> pavadinimų žodynas
    const STATUS_MAP = {
      1: "Vykdoma",
      6: "Sukurta"
      // 4 specialiai NENAUDOJAM pagal tavo sąlygą
    };

    // LKS (EPSG:3346) -> WGS84 konvertavimas
    // formulė apytikslė, bet Vilniui pakanka
    function lksToWgs(x, y) {
      // LKS (TM, GRS80, EPSG:3346) -> lat/lon (WGS84)
      const a = 6378137.0;
      const f = 1 / 298.257222101;
      const k0 = 0.9998;
      const e2 = 2 * f - f * f;

      // centrinis meridianas Lietuvai ~ 24E
      const lambda0 = 24 * Math.PI / 180;

      const x0 = 500000;
      const y0 = 0;

      const E = x;
      const N = y;

      const M = (N - y0) / k0;
      const mu =
        M /
        (a *
          (1 -
            e2 / 4 -
            (3 * e2 * e2) / 64 -
            (5 * e2 * e2 * e2) / 256));

      const e1 =
        (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));

      const J1 = (3 * e1) / 2 - (27 * e1 * e1 * e1) / 32;
      const J2 = (21 * e1 * e1) / 16 - (55 * e1 * e1 * e1 * e1) / 32;
      const J3 = (151 * e1 * e1 * e1) / 96;
      const J4 = (1097 * e1 * e1 * e1 * e1) / 512;

      const fp =
        mu +
        J1 * Math.sin(2 * mu) +
        J2 * Math.sin(4 * mu) +
        J3 * Math.sin(6 * mu) +
        J4 * Math.sin(8 * mu);

      const e2prime = e2 / (1 - e2);

      const sinfp = Math.sin(fp);
      const cosfp = Math.cos(fp);
      const tanfp = Math.tan(fp);

      const C1 = e2prime * cosfp * cosfp;
      const T1 = tanfp * tanfp;
      const R1 =
        (a * (1 - e2)) /
        Math.pow(1 - e2 * sinfp * sinfp, 1.5);
      const N1 = a / Math.sqrt(1 - e2 * sinfp * sinfp);
      const D = (E - x0) / (N1 * k0);

      let lat =
        fp -
        ((N1 * tanfp) / R1) *
          (D * D / 2 -
            (5 + 3 * T1 + 10 * C1 - 4 * C1 * C1 - 9 * e2prime) *
              Math.pow(D, 4) /
              24 +
            (61 +
              90 * T1 +
              298 * C1 +
              45 * T1 * T1 -
              252 * e2prime -
              3 * C1 * C1) *
              Math.pow(D, 6) /
              720);

      let lon =
        lambda0 +
        (D -
          (1 + 2 * T1 + C1) * Math.pow(D, 3) / 6 +
          (5 -
            2 * C1 +
            28 * T1 -
            3 * C1 * C1 +
            8 * e2prime +
            24 * T1 * T1) *
            Math.pow(D, 5) /
            120) /
          cosfp;

      lat = (lat * 180) / Math.PI;
      lon = (lon * 180) / Math.PI;
      return { lat, lon };
    }

    // Paprastas Leaflet žemėlapis
    const map = L.map("map").setView([54.69, 25.28], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap"
    }).addTo(map);

    const listEl = document.getElementById("list");
    const filterInput = document.getElementById("filter");
    const statusBar = document.getElementById("status-bar");

    let allItems = []; // { polygon, rowEl, searchText }

    function createQueryUrl() {
      const params = new URLSearchParams({
        where: "1=1",          // jokių Statusas sąlygų – filtruosim kliente
        outFields: "*",
        returnGeometry: "true",
        f: "pjson"
      });
      return arcgisLayerUrl + "/query?" + params.toString();
    }

    function renderList(items) {
      listEl.innerHTML = "";
      items.forEach((item) => listEl.appendChild(item.rowEl));
      statusBar.textContent = "Rodoma " + items.length + " užduočių";
    }

    function applyFilter() {
      const q = filterInput.value.trim().toLowerCase();
      if (!q) return renderList(allItems);
      const filtered = allItems.filter((item) =>
        (item.searchText || "").toLowerCase().includes(q)
      );
      renderList(filtered);
    }

    async function loadData() {
      try {
        const resp = await fetch(createQueryUrl());
        const text = await resp.text();

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error("Nepavyko išparsinti JSON:", text);
          statusBar.textContent = "Klaida: blogas atsakas iš serviso";
          return;
        }

        if (data.error) {
          console.error("ArcGIS error:", data.error);
          statusBar.textContent = "ArcGIS klaida: " + (data.error.message || "");
          return;
        }

        if (!data.features || !data.features.length) {
          statusBar.textContent = "Nerasta objektų";
          return;
        }

        const polygons = [];
        allItems = [];

        data.features.forEach((f) => {
          const attrs = f.attributes || {};
          const statusCode = attrs.Statusas ?? attrs.statusas;

          // Tik statusai 1 arba 6
          if (statusCode !== 1 && statusCode !== 6) return;

          const statusText =
            STATUS_MAP[statusCode] || ("Statusas " + statusCode);

          const imoneCode = attrs.Imone ?? attrs.imone;
          const imoneText =
            IMONE_MAP[imoneCode] || ("Įmonė kodas " + imoneCode);

          const objectId =
            attrs.OBJECTID ?? attrs.ObjectID ?? attrs.objectid;

          const g = f.geometry;
          if (!g || !g.rings || !g.rings.length) return;

          // Konvertuojam visą poligoną iš LKS į WGS
          const latlngRings = g.rings.map((ring) =>
            ring.map((coord) => {
              const { lat, lon } = lksToWgs(coord[0], coord[1]);
              return [lat, lon]; // Leaflet [lat, lng]
            })
          );

          const polygon = L.polygon(latlngRings, {
            color: "#ff7800",
            weight: 2,
            fillColor: "#ffcc66",
            fillOpacity: 0.5
          });

          // Pop-up tekstas
          const center = polygon.getBounds().getCenter();
          const popupHtml =
            `<b>Užduotis #${objectId}</b><br>` +
            `Įmonė: ${imoneText}<br>` +
            `Statusas: ${statusText}<br>` +
            `Lat: ${center.lat.toFixed(5)} | Lon: ${center.lng.toFixed(5)}`;

          polygon.bindPopup(popupHtml);

          polygon.addTo(map);
          polygons.push(polygon);

          // Sąrašo eilutė
          const row = document.createElement("div");
          row.className = "feature-row";
          row.innerHTML =
            `<div class="row-title">#${objectId} – ${imoneText}</div>` +
            `<div class="row-sub">Statusas: ${statusText}</div>`;

          row.onclick = () => {
            const bounds = polygon.getBounds();
            map.fitBounds(bounds.pad(0.1));
            polygon.openPopup();
            document
              .querySelectorAll(".feature-row.active")
              .forEach((el) => el.classList.remove("active"));
            row.classList.add("active");
          };

          polygon.on("click", () => {
            row.scrollIntoView({ behavior: "smooth", block: "center" });
            document
              .querySelectorAll(".feature-row.active")
              .forEach((el) => el.classList.remove("active"));
            row.classList.add("active");
          });

          allItems.push({
            polygon,
            rowEl: row,
            searchText: `${objectId} ${imoneText} ${statusText}`
          });
        });

        if (!polygons.length) {
          statusBar.textContent =
            "Pagal filtrą (Statusas 1 arba 6) objektų nėra";
          return;
        }

        const group = L.featureGroup(polygons);
        map.fitBounds(group.getBounds().pad(0.1));

        renderList(allItems);
      } catch (e) {
        console.error(e);
        statusBar.textContent = "Klaida įkeliant duomenis";
      }
    }

    if (filterInput) filterInput.addEventListener("input", applyFilter);
    loadData();
  </script>
</body>
</html>
