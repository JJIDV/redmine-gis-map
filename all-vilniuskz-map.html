<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>PROJ užduotys – poligonai (Statusas 1, 6)</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- proj4 – koordinačių transformacijoms -->
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.1/dist/proj4.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #app {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #map {
      flex: 1;
    }

    /* Šoninė juosta */
    #sidebar {
      flex: 0 0 180px;
      max-width: 180px;
      border-left: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      font-size: 12px;
    }

    #sidebar-header {
      padding: 6px 8px;
      border-bottom: 1px solid #ddd;
      background: #f7f7f7;
      font-weight: 600;
      font-size: 12px;
      text-align: center;
    }

    #filter {
      padding: 4px 6px;
      border: none;
      border-bottom: 1px solid #ddd;
      outline: none;
      font-size: 12px;
    }

    #list {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
    }

    .feature-row {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .feature-row:hover {
      background: #f0f8ff;
    }

    .feature-row.active {
      background: #e6f2ff;
    }

    .row-title {
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-sub {
      color: #555;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-status {
      color: #777;
      font-size: 10px;
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #status-bar {
      padding: 3px 6px;
      border-top: 1px solid #ddd;
      font-size: 10px;
      color: #555;
      background: #fafafa;
      text-align: center;
    }

    /* Mobiliai – slepiam šoninę juostą */
    @media (max-width: 600px) {
      #sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <div id="sidebar">
      <div id="sidebar-header">Užduotys (st. 1, 6)</div>
      <input id="filter" type="text" placeholder="Filtruoti pagal įmonę / statusą..." />
      <div id="list"></div>
      <div id="status-bar">Kraunama...</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ArcGIS MapServer sluoksnis
    const arcgisLayerUrl =
      "https://opencity.idvilnius.lt/atviras/rest/services/Eismo_valdymas/Uzduotys_PROJ_QL/MapServer/0";

    // Filtras – tik neuždarytos
    const whereClause = "Statusas IN (1, 6)";

    // Statuso kodų vertimas į tekstą
    const statusLookup = {
      1: "Vykdoma",
      4: "Atlikta",
      6: "Sukurta"
    };

    // Įmonių kodų vertimas į tekstus
    const companyLookup = {
      0: "Nenurodyta",
      1: "VMSA",
      2: "SISP",
      3: "VVT",
      4: "Grinda",
      5: "Biseris",
      6: "Maniga",
      7: "Gatas"
    };

    // Apibrėžiam LKS-94 (EPSG:3346)
    proj4.defs(
      "EPSG:3346",
      "+proj=tmerc +lat_0=0 +lon_0=24 +k=0.9998 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs"
    );

    function lksToWgs(x, y) {
      // proj4 grąžina [lon, lat]
      const [lon, lat] = proj4("EPSG:3346", "EPSG:4326", [x, y]);
      return [lat, lon]; // Leaflet tvarka
    }

    // Inicializuojam žemėlapį
    const map = L.map("map").setView([54.6872, 25.2797], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap"
    }).addTo(map);

    const listEl = document.getElementById("list");
    const filterInput = document.getElementById("filter");
    const statusBar = document.getElementById("status-bar");
    let allItems = [];

    function createQueryUrl() {
      const params = new URLSearchParams({
        where: whereClause,
        outFields: "OBJECTID,Statusas,Imone",
        returnGeometry: "true",
        f: "json"
      });
      const url = arcgisLayerUrl + "/query?" + params.toString();
      console.log("Query URL:", url);
      return url;
    }

    function getPolygonCentroid(geometry) {
      if (!geometry || !geometry.rings || !geometry.rings.length) return null;
      const ring = geometry.rings[0];
      let xSum = 0, ySum = 0, count = 0;

      for (const pt of ring) {
        const x = pt[0];
        const y = pt[1];
        xSum += x;
        ySum += y;
        count++;
      }
      if (!count) return null;
      const xMean = xSum / count;
      const yMean = ySum / count;
      return lksToWgs(xMean, yMean); // jau [lat, lon]
    }

    function polygonToLatLngs(geometry) {
      if (!geometry || !geometry.rings) return [];
      return geometry.rings.map(ring =>
        ring.map(([x, y]) => lksToWgs(x, y))
      );
    }

    function renderList(items) {
      if (!listEl) return;
      listEl.innerHTML = "";
      items.forEach((item) => listEl.appendChild(item.rowEl));
      statusBar.textContent = "Rodomi " + items.length + " objektai";
    }

    function applyFilter() {
      const q = filterInput.value.trim().toLowerCase();
      if (!q) {
        renderList(allItems);
        return;
      }
      const filtered = allItems.filter((item) =>
        (item.searchText || "").toLowerCase().includes(q)
      );
      renderList(filtered);
    }

    async function loadData() {
      try {
        const resp = await fetch(createQueryUrl());
        const data = await resp.json();

        if (data.error) {
          console.error("ArcGIS error:", data.error);
          statusBar.textContent = "Klaida iš serverio (žr. konsolę)";
          return;
        }

        if (!data.features || !data.features.length) {
          statusBar.textContent = "Nerasta objektų";
          return;
        }

        const featureLayer = L.featureGroup().addTo(map);
        allItems = [];

        data.features.forEach((f) => {
          const attrs = f.attributes || {};
          const geom = f.geometry;

          const statusCode = attrs.Statusas;
          if (statusCode !== 1 && statusCode !== 6) return;

          const statusText = statusLookup[statusCode] || ("Kodas: " + statusCode);
          const companyText = companyLookup[attrs.Imone] || ("Imonės kodas: " + attrs.Imone);
          const objectId = attrs.OBJECTID;

          const centroid = getPolygonCentroid(geom);
          if (!centroid) return;

          const polygonLatLngs = polygonToLatLngs(geom);
          if (!polygonLatLngs.length) return;

          const polygon = L.polygon(polygonLatLngs, {
            color: "#ff6600",
            weight: 2,
            fillColor: "#ffcc66",
            fillOpacity: 0.4
          }).addTo(featureLayer);

          const popupHtml = `
            <b>Užduotis #${objectId}</b><br/>
            Įmonė: ${companyText}<br/>
            Statusas: ${statusText}<br/>
            Lat: ${centroid[0].toFixed(5)} | Lon: ${centroid[1].toFixed(5)}
          `;
          polygon.bindPopup(popupHtml);

          if (listEl) {
            const row = document.createElement("div");
            row.className = "feature-row";
            row.innerHTML = `
              <div class="row-title">Užduotis #${objectId}</div>
              <div class="row-sub">${companyText}</div>
              <div class="row-status">Statusas: ${statusText}</div>
            `;

            row.onclick = () => {
              map.setView(centroid, 15);
              polygon.openPopup();
              document
                .querySelectorAll(".feature-row.active")
                .forEach(el => el.classList.remove("active"));
              row.classList.add("active");
            };

            polygon.on("click", () => {
              row.scrollIntoView({ behavior: "smooth", block: "center" });
              document
                .querySelectorAll(".feature-row.active")
                .forEach(el => el.classList.remove("active"));
              row.classList.add("active");
            });

            allItems.push({
              polygon,
              rowEl: row,
              searchText: `${objectId} ${companyText} ${statusText}`
            });
          }
        });

        if (featureLayer.getLayers().length) {
          map.fitBounds(featureLayer.getBounds().pad(0.1));
        }

        renderList(allItems);
      } catch (e) {
        console.error(e);
        statusBar.textContent = "Klaida įkeliant duomenis";
      }
    }

    if (filterInput) {
      filterInput.addEventListener("input", applyFilter);
    }

    loadData();
  </script>
</body>
</html>
