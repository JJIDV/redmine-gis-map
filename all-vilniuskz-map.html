<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Vilniaus užduotys (statusai 1, 4, 6)</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    #app {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #map {
      flex: 1;
    }

    #sidebar {
      flex: 0 0 180px;
      max-width: 180px;
      border-left: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      font-size: 12px;
      background: #fff;
    }

    #sidebar-header {
      padding: 6px 8px;
      border-bottom: 1px solid #ddd;
      background: #f7f7f7;
      font-weight: 600;
      font-size: 12px;
      text-align: center;
    }

    #filter {
      padding: 4px 6px;
      border: none;
      border-bottom: 1px solid #ddd;
      outline: none;
      font-size: 12px;
    }

    #list {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
    }

    .feature-row {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .feature-row:hover {
      background: #f0f8ff;
    }

    .feature-row.active {
      background: #e6f2ff;
    }

    .row-title {
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-sub {
      color: #555;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-sub2 {
      color: #777;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #status-bar {
      padding: 3px 6px;
      border-top: 1px solid #ddd;
      font-size: 10px;
      color: #555;
      background: #fafafa;
      text-align: center;
    }

    @media (max-width: 600px) {
      #sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <div id="sidebar">
      <div id="sidebar-header">Užduotys (st. 1, 4, 6)</div>
      <input id="filter" type="text" placeholder="Filtruoti pagal įmonę / statusą..." />
      <div id="list"></div>
      <div id="status-bar">Kraunama...</div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // ===== KONFIGŪRACIJA =====
    const arcgisLayerUrl =
      "https://opencity.idvilnius.lt/atviras/rest/services/Eismo_valdymas/Uzduotys_PROJ_QL/MapServer/0";

    // lauko pavadinimas servise yra 'statusas' (mažosiomis)
    const whereClause = "statusas IN (1, 4, 6)";

    // statuso kodas -> tekstas
    const statusLookup = {
      1: "Vykdoma",
      4: "Atlikta",
      6: "Sukurta"
    };

    // Imone kodas -> tekstas
    const companyLookup = {
      0: "Nenurodyta",
      1: "VMSA",
      2: "SISP",
      3: "VVT",
      4: "Grinda",
      5: "Biseris",
      6: "Maniga",
      7: "Gatas"
    };

    // LKS -> WGS84 (EPSG:3346 -> EPSG:4326), apytikslė transformacija
    function lksToWgs(x, y) {
      const a = 6378137.0;
      const f = 1 / 298.257223563;
      const e2 = 2 * f - f * f;
      const λ0 = 24 * Math.PI / 180;
      const k0 = 0.9998;
      const x0 = 500000;
      const y0 = 0;

      const xx = (x - x0) / k0;
      const yy = (y - y0) / k0;

      const m = yy;
      const mu = m / (a * (1 - e2 / 4 - 3 * e2 * e2 / 64 - 5 * e2 * e2 * e2 / 256));
      const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));

      const j1 = 3 * e1 / 2 - 27 * Math.pow(e1, 3) / 32;
      const j2 = 21 * e1 * e1 / 16 - 55 * Math.pow(e1, 4) / 32;
      const j3 = 151 * Math.pow(e1, 3) / 96;
      const j4 = 1097 * Math.pow(e1, 4) / 512;

      const fp =
        mu +
        j1 * Math.sin(2 * mu) +
        j2 * Math.sin(4 * mu) +
        j3 * Math.sin(6 * mu) +
        j4 * Math.sin(8 * mu);

      const sinfp = Math.sin(fp);
      const cosfp = Math.cos(fp);
      const tanfp = Math.tan(fp);

      const c1 = e2 / (1 - e2) * cosfp * cosfp;
      const t1 = tanfp * tanfp;
      const r1 =
        a * (1 - e2) /
        Math.pow(1 - e2 * sinfp * sinfp, 1.5);
      const n1 = a / Math.sqrt(1 - e2 * sinfp * sinfp);

      const d = xx / n1;

      const q1 = (n1 * tanfp) / r1;
      const q2 = (d * d) / 2;
      const q3 =
        (5 + 3 * t1 + 10 * c1 - 4 * c1 * c1 - 9 * e2 / (1 - e2)) *
        Math.pow(d, 4) / 24;
      const q4 =
        (61 + 90 * t1 + 298 * c1 + 45 * t1 * t1 - 252 * e2 / (1 - e2) - 3 * c1 * c1) *
        Math.pow(d, 6) / 720;

      const lat = fp - q1 * (q2 - q3 + q4);

      const q5 = d;
      const q6 = (1 + 2 * t1 + c1) * Math.pow(d, 3) / 6;
      const q7 =
        (5 - 2 * c1 + 28 * t1 - 3 * c1 * c1 + 8 * e2 / (1 - e2) + 24 * t1 * t1) *
        Math.pow(d, 5) / 120;

      const lon = λ0 + (q5 - q6 + q7) / cosfp;

      return [lat * 180 / Math.PI, lon * 180 / Math.PI];
    }

    // ===== ŽEMĖLAPIS =====
    const map = L.map("map").setView([54.69, 25.28], 12);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap"
    }).addTo(map);

    const clusterGroup = L.markerClusterGroup();

    const listEl = document.getElementById("list");
    const filterInput = document.getElementById("filter");
    const statusBar = document.getElementById("status-bar");
    let allItems = [];

    function createQueryUrl() {
      const params = new URLSearchParams({
        where: whereClause,
        outFields: "*",
        returnGeometry: "true",
        f: "pjson"
      });
      return arcgisLayerUrl + "/query?" + params.toString();
    }

    function renderList(items) {
      if (!listEl) return;
      listEl.innerHTML = "";
      items.forEach((item) => listEl.appendChild(item.rowEl));
      statusBar.textContent = "Rodomos " + items.length + " užduotys (statusai 1, 4, 6)";
    }

    function applyFilter() {
      const q = filterInput.value.trim().toLowerCase();
      if (!q) return renderList(allItems);
      const filtered = allItems.filter((item) =>
        (item.searchText || "").toLowerCase().includes(q)
      );
      renderList(filtered);
    }

    async function loadData() {
      try {
        const url = createQueryUrl();
        console.log("Query URL:", url);
        const resp = await fetch(url);
        const data = await resp.json();
        console.log("Raw response:", data);

        if (data.error) {
          console.error("ArcGIS error:", data.error);
          statusBar.textContent = "ArcGIS klaida (žiūrėk Console)";
          return;
        }

        if (!data.features || !Array.isArray(data.features) || data.features.length === 0) {
          statusBar.textContent = "Nerasta jokių užduočių";
          return;
        }

        const markers = [];

        data.features.forEach((f) => {
          const a = f.attributes || {};
          const geom = f.geometry;

          if (!geom || !geom.rings || !geom.rings.length) return;

          // poligono centro aproksimacija
          let sumX = 0;
          let sumY = 0;
          let count = 0;
          geom.rings[0].forEach((pt) => {
            sumX += pt[0];
            sumY += pt[1];
            count++;
          });
          if (!count) return;
          const cx = sumX / count;
          const cy = sumY / count;

          const [lat, lon] = lksToWgs(cx, cy);

          const statusCode = a.statusas;   // <-- NAUJAS: mažosiomis
          const statusText = statusLookup[statusCode] || ("Kodas: " + statusCode);
          const companyCode = a.imone;     // <-- NAUJAS: mažosiomis
          const companyText = companyLookup[companyCode] || ("Kodas: " + companyCode);
          const id = a.OBJECTID;

          const popupHtml =
            `<b>Užduotis #${id}</b><br/>` +
            `Įmonė: ${companyText}<br/>` +
            `Statusas: ${statusText}<br/>` +
            `Lat: ${lat.toFixed(5)} | Lon: ${lon.toFixed(5)}`;

          const marker = L.marker([lat, lon]);
          marker.bindPopup(popupHtml);

          clusterGroup.addLayer(marker);
          markers.push(marker);

          if (!listEl) return;

          const row = document.createElement("div");
          row.className = "feature-row";

          const titleEl = document.createElement("div");
          titleEl.className = "row-title";
          titleEl.textContent = "Užduotis #" + id;

          const subEl = document.createElement("div");
          subEl.className = "row-sub";
          subEl.textContent = "Įmonė: " + companyText;

          const sub2El = document.createElement("div");
          sub2El.className = "row-sub2";
          sub2El.textContent = "Statusas: " + statusText;

          row.appendChild(titleEl);
          row.appendChild(subEl);
          row.appendChild(sub2El);

          row.addEventListener("click", () => {
            map.setView([lat, lon], 18);
            marker.openPopup();
            document
              .querySelectorAll(".feature-row.active")
              .forEach((el) => el.classList.remove("active"));
            row.classList.add("active");
          });

          marker.on("click", () => {
            row.scrollIntoView({ behavior: "smooth", block: "center" });
            document
              .querySelectorAll(".feature-row.active")
              .forEach((el) => el.classList.remove("active"));
            row.classList.add("active");
          });

          allItems.push({
            marker,
            rowEl: row,
            searchText: `${id} ${companyText} ${statusText}`
          });
        });

        map.addLayer(clusterGroup);

        if (markers.length) {
          const group = L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
        }

        renderList(allItems);
      } catch (e) {
        console.error(e);
        statusBar.textContent = "Klaida įkeliant duomenis (žiūrėk Console)";
      }
    }

    if (filterInput) filterInput.addEventListener("input", applyFilter);

    loadData();
  </script>
</body>
</html>
