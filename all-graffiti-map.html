<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Graffiti – visi objektai</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    #app {
      display: flex;
      height: 100%;
      width: 100%;
    }

    #map {
      flex: 1;
    }

    /* Šoninis sąrašas */
    #sidebar {
      flex: 0 0 160px;
      max-width: 160px;
      border-left: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      font-size: 12px;
      background: #fff;
    }

    #sidebar-header {
      padding: 6px 8px;
      border-bottom: 1px solid #ddd;
      background: #f7f7f7;
      font-weight: 600;
      font-size: 12px;
      text-align: center;
    }

    #filter {
      padding: 4px 6px;
      border: none;
      border-bottom: 1px solid #ddd;
      outline: none;
      font-size: 12px;
    }

    #list {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
    }

    .feature-row {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .feature-row:hover {
      background: #f0f8ff;
    }

    .feature-row.active {
      background: #e6f2ff;
    }

    .row-title {
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-sub {
      color: #555;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-coords {
      color: #777;
      font-size: 10px;
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #status-bar {
      padding: 3px 6px;
      border-top: 1px solid #ddd;
      font-size: 10px;
      color: #555;
      background: #fafafa;
      text-align: center;
    }

    /* Siaurame ekrane sąrašą paslepiam */
    @media (max-width: 700px) {
      #sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <div id="sidebar">
      <div id="sidebar-header">Taškai (visi)</div>
      <input id="filter" type="text" placeholder="Filtruoti..." />
      <div id="list"></div>
      <div id="status-bar">Kraunama...</div>
    </div>
  </div>

  <!-- JS bibliotekos -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>

  <script>
    // ArcGIS MapServer sluoksnis
    const arcgisLayerUrl =
      "https://opencity.idvilnius.lt/atviras/rest/services/Miesto_tvark/Grafiti_view_Public/MapServer/0";

    // Jei norėsi rodyti tik vykdomus: 
    // const whereClause = "statusas_name = 'Vykdoma (Rangovai)'";
    const whereClause = "1=1";

    // Žemėlapis
    const map = L.map("map").setView([54.69, 25.28], 12);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap"
    }).addTo(map);

    const listEl = document.getElementById("list");
    const filterInput = document.getElementById("filter");
    const statusBar = document.getElementById("status-bar");

    let allItems = []; // {layer, rowEl, searchText}

    function renderList(items) {
      if (!listEl) return;
      listEl.innerHTML = "";
      items.forEach((it) => listEl.appendChild(it.rowEl));
      statusBar.textContent = "Rodomi " + items.length + " objektai";
    }

    function applyFilter() {
      const q = (filterInput.value || "").trim().toLowerCase();
      if (!q) {
        renderList(allItems);
        return;
      }
      const filtered = allItems.filter((it) =>
        (it.searchText || "").toLowerCase().includes(q)
      );
      renderList(filtered);
    }

    if (filterInput) {
      filterInput.addEventListener("input", applyFilter);
    }

    // Feature sluoksnis iš ArcGIS (Esri Leaflet)
    const featureLayer = L.esri.featureLayer({
      url: arcgisLayerUrl,
      where: whereClause,
      pointToLayer: function (geojson, latlng) {
        // markerio stilius
        return L.circleMarker(latlng, {
          radius: 6,
          fillColor: "#ff5722",
          color: "#333",
          weight: 1,
          fillOpacity: 0.9
        });
      },
      onEachFeature: function (feature, layer) {
        const a = feature.properties || {};
        const latlng = layer.getLatLng();

        const rangovas = a.rangovas || "(be rangovo)";
        const adresas = a.adresas || "";
        const statusas = a.statusas_name || "";
        const tvarkymas = a.tvark_tipas_name || "";

        // POPUP – vietoj "Graffiti #..." naudojam rangovas (įmonė)
        const popupHtml =
          "<b>" +
          rangovas +
          "</b><br/>" +
          (adresas ? adresas + "<br/>" : "") +
          (statusas ? "Statusas: " + statusas + "<br/>" : "") +
          (tvarkymas ? "Tvarkymo tipas: " + tvarkymas + "<br/>" : "") +
          "Lat: " +
          latlng.lat.toFixed(5) +
          "<br/>Lon: " +
          latlng.lng.toFixed(5);

        layer.bindPopup(popupHtml);

        // Eilutė sąraše
        if (listEl) {
          const row = document.createElement("div");
          row.className = "feature-row";

          const titleEl = document.createElement("div");
          titleEl.className = "row-title";
          titleEl.textContent = rangovas;

          const subEl = document.createElement("div");
          subEl.className = "row-sub";
          subEl.textContent = adresas || statusas || "";

          const coordsEl = document.createElement("div");
          coordsEl.className = "row-coords";
          coordsEl.textContent =
            "Lat: " +
            latlng.lat.toFixed(5) +
            " | Lon: " +
            latlng.lng.toFixed(5);

          row.appendChild(titleEl);
          row.appendChild(subEl);
          row.appendChild(coordsEl);

          // Sąveika su žemėlapiu
          row.addEventListener("click", () => {
            map.setView(latlng, 18);
            layer.openPopup();

            document
              .querySelectorAll(".feature-row.active")
              .forEach((el) => el.classList.remove("active"));
            row.classList.add("active");
          });

          layer.on("click", () => {
            row.scrollIntoView({ behavior: "smooth", block: "center" });
            document
              .querySelectorAll(".feature-row.active")
              .forEach((el) => el.classList.remove("active"));
            row.classList.add("active");
          });

          const searchText =
            rangovas +
            " " +
            adresas +
            " " +
            statusas +
            " " +
            tvarkymas +
            " " +
            JSON.stringify(a);

          allItems.push({
            layer,
            rowEl: row,
            searchText
          });
        }
      }
    }).addTo(map);

    // Kai sluoksnis užsikrauna – pritaikom ribas ir atvaizduojam sąrašą
    featureLayer.once("load", function () {
      try {
        const bounds = featureLayer.getBounds();
        if (bounds && bounds.isValid()) {
          map.fitBounds(bounds.pad(0.1));
        }
      } catch (e) {
        console.warn("Nepavyko nustatyti ribų:", e);
      }

      renderList(allItems);
    });

    featureLayer.on("loading", function () {
      statusBar.textContent = "Kraunama...";
    });

    featureLayer.on("load", function () {
      if (!allItems.length) {
        statusBar.textContent = "Nerasta objektų";
      }
    });
  </script>
</body>
</html>
