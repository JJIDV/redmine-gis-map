<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Graffiti – statusas=3 pagal tvarkymo tipą</title>

  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #fafafa;
    }

    h2 {
      margin: 12px 0 6px 0;
      text-align: center;
      font-size: 16px;
      color: #333;
    }

    .map-wrapper {
      width: 100%;
      height: 380px;
      margin: 0 auto 24px auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
    }

    .map {
      width: 100%;
      height: 100%;
      border-radius: 4px;
    }

    .status-bar {
      font-size: 12px;
      text-align: center;
      color: #555;
      padding: 4px 0;
    }

    @media (max-width: 1000px) {
      .map-wrapper {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <h2>Dažoma (tvark_tipas = 1, statusas = 3)</h2>
  <div class="map-wrapper">
    <div id="map1" class="map"></div>
    <div id="status1" class="status-bar">Kraunama...</div>
  </div>

  <h2>Valoma (tvark_tipas = 2, statusas = 3)</h2>
  <div class="map-wrapper">
    <div id="map2" class="map"></div>
    <div id="status2" class="status-bar">Kraunama...</div>
  </div>

  <h2>Kiti tipai (statusas = 3, tvark_tipas ≠ 1,2)</h2>
  <div class="map-wrapper">
    <div id="map3" class="map"></div>
    <div id="status3" class="status-bar">Kraunama...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const arcgisLayerUrl =
      "https://opencity.idvilnius.lt/server/rest/services/redmine_map/FeatureServer/0";

    // trijų žemėlapių konfigūracija
    const mapsConfig = [
      { id: "map1", statusId: "status1", where: "statusas = 3 AND tvark_tipas = 1", color: "red" },
      { id: "map2", statusId: "status2", where: "statusas = 3 AND tvark_tipas = 2", color: "blue" },
      { id: "map3", statusId: "status3", where: "statusas = 3 AND (tvark_tipas <> 1 AND tvark_tipas <> 2)", color: "green" }
    ];

    // bendra funkcija duomenims užkrauti
    async function loadMap(config) {
      const map = L.map(config.id).setView([54.6905, 25.2799], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "© OpenStreetMap"
      }).addTo(map);

      const statusEl = document.getElementById(config.statusId);
      const url =
        arcgisLayerUrl +
        "/query?where=" +
        encodeURIComponent(config.where) +
        "&outFields=*&returnGeometry=true&outSR=4326&f=pjson";

      try {
        const resp = await fetch(url);
        const data = await resp.json();

        if (!data.features || !data.features.length) {
          statusEl.textContent = "Nerasta objektų.";
          return;
        }

        const markers = [];
        data.features.forEach((f) => {
          const g = f.geometry;
          const a = f.attributes || {};
          if (!g || g.x == null || g.y == null) return;
          const lat = g.y, lon = g.x;

          const marker = L.circleMarker([lat, lon], {
            radius: 6,
            fillColor: config.color,
            color: "#333",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          })
            .addTo(map)
            .bindPopup(
              `<b>ID:</b> ${a.ID || a.OBJECTID || "-"}<br>` +
                `<b>Adresas:</b> ${a.adresas || "-"}<br>` +
                `<b>Statusas:</b> ${a.statusas}<br>` +
                `<b>Tvarkymo tipas:</b> ${a.tvark_tipas}`
            );

          markers.push(marker);
        });

        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
        statusEl.textContent = "Rodoma " + markers.length + " objektų.";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Klaida kraunant duomenis.";
      }
    }

    // paleidžiam visus 3 žemėlapius
    mapsConfig.forEach((cfg) => loadMap(cfg));
  </script>
</body>
</html>
