<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <title>Grafiti žemėlapis</title>

  <!-- Leaflet CSS/JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kGStb6g2nL1qHg2PjH8zWLMKXgB3p3f2kPGzU="
    crossorigin=""
  ></script>

  <!-- Klasteriavimas (nebūtina, bet labai padeda kai daug taškų) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // --------------------------------------------------------------------
    // KONFIGŪRACIJA – PRIREIKUS PASIKEISK ČIA
    // --------------------------------------------------------------------

    // ArcGIS Feature/Map service sluoksnio URL (0 sluoksnis)
    const featureLayerUrl =
      "https://opencity.idvilnius.lt/server/rest/services/TESTAVIMAI/Grafiti/MapServer/0";
      // jei naudosi MapServer, gali būti .../MapServer/0

    // Laukai, kuriuos norim matyti popup'e
    const fields = [
      "OBJECTID",
      "statinio_tip",
      "statusas_tvirtinimas",
      "uzsak_vykd_data"
    ];

    // Pradinis žemėlapio centras ir mastelis (Vilnius)
    const initialCenter = [54.6872, 25.2797];
    const initialZoom = 12;

    // --------------------------------------------------------------------
    // ŽEMĖLAPIS
    // --------------------------------------------------------------------

    const map = L.map("map").setView(initialCenter, initialZoom);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20,
      attribution: "© OpenStreetMap"
    }).addTo(map);

    const clusterGroup = L.markerClusterGroup();
    map.addLayer(clusterGroup);

    // --------------------------------------------------------------------
    // Duomenų užklausa iš ArcGIS kaip GeoJSON
    // --------------------------------------------------------------------

    const queryUrl =
      featureLayerUrl +
      "/query" +
      "?where=1=1" +
      "&outFields=" +
      encodeURIComponent(fields.join(",")) +
      "&outSR=4326" +
      "&f=geojson";

    fetch(queryUrl)
      .then((res) => res.json())
      .then((geojson) => {
        addFeaturesToMap(geojson);
      })
      .catch((err) => {
        console.error("Nepavyko nuskaityti duomenų iš serviso:", err);
      });

    // --------------------------------------------------------------------
    // Taškų uždėjimas ant žemėlapio
    // --------------------------------------------------------------------

    function addFeaturesToMap(geojson) {
      const markers = [];

      geojson.features.forEach((feat) => {
        if (!feat.geometry || feat.geometry.type !== "Point") return;

        const coords = feat.geometry.coordinates; // [lon, lat]
        const lon = coords[0];
        const lat = coords[1];
        const props = feat.properties || {};

        const marker = L.circleMarker([lat, lon], {
          radius: 4,
          fillColor: "#ff3333",
          color: "#800000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        });

        const popupHtml = `
          <div style="font-size:12px">
            <div><strong>ID:</strong> ${props.OBJECTID}</div>
            <div><strong>Statinio tipas:</strong> ${props.statinio_tip ?? "-"}</div>
            <div><strong>Statusas:</strong> ${
              props.statusas_tvirtinimas ?? "-"
            }</div>
            <div><strong>Užsakymo data:</strong> ${
              props.uzsak_vykd_data ?? "-"
            }</div>
          </div>
        `;
        marker.bindPopup(popupHtml);

        clusterGroup.addLayer(marker);
        markers.push(marker);
      });

      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }
  </script>
</body>
</html>
